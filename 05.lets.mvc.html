<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Web Development &mdash; Backend Development</title>

		<meta name="description" content="Web Development &mdash; Backend Development &mdash; 05.lets.mvc">
		<meta name="author" content="Joris Maervoet - ikdoeict.be">

		<link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/main.css" media="screen">
		<link rel="stylesheet" href="css/print.css" media="print">

		<link rel="stylesheet" href="lib/zenburn.css">
		<style>
			html, body {
				background: #34afbd;
				background: -moz-radial-gradient(center, ellipse cover, #34afbd 0%,#1c1e20 100%);
				background: -webkit-gradient(radial, center center, 0px, center center, 100%, color-stop(0%,#34afbd), color-stop(100%,#1c1e20));
				background: -webkit-radial-gradient(center, ellipse cover, #34afbd 0%,#1c1e20 100%);
				background: -o-radial-gradient(center, ellipse cover, #34afbd 0%,#1c1e20 100%);
				background: -ms-radial-gradient(center, ellipse cover, #34afbd 0%,#1c1e20 100%);
				background: radial-gradient(center, ellipse cover, #34afbd 0%,#1c1e20 100%);
				letter-spacing: 0em;
			}

			#reveal nav {
				opacity: 0.3;
				letter-spacing: -0.02em;
			}
		</style>
	</head>

	<body>

		<div id="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">


				<!-- Title -->
				<section>
					<section>
						<h3 class="inverted">Backend Development <small>[JLW506]</small></h3>
						<h1>05.Let's MVC</h1>

						<footer>
							<em>Course materials: <a href="mailto:joris.maervoet@odisee.be">Joris Maervoet</a></em>
						</footer>
						<script>
							// Delicously hacky. Look away.
							if( navigator.userAgent.match( /(iPhone|iPad|iPod|Android)/i ) )
							document.write( '<p style="color: rgba(0,0,0,0.3); text-shadow: none;">('+'Tap to navigate'+')</p>' );
						</script>
					</section>
				</section>

				<section>
					<section>
						<h2>Introducing MVC</h2>
					</section>

					<section>
						<h2>MVC</h2>
						<ul>
							<li class="fragment">
								Short for <strong>Model-View-Controller</strong>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Architectural pattern describing how to build your app
							</li>
							<li class="fragment" style="margin-top: 1em;">
								In a web-context:
								<ul>
									<li class="fragment">The model represents data</li>
									<li class="fragment">The view visually represents the model</li>
									<li class="fragment">The controller is the app logic: decides what the input was, and orchestrates the proper models/views</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								This presentation is about <strong>structuring</strong> our Laravel code into MVC
							</li>
						</ul>
					</section>

					<section>
						<h2>Schematic</h2>
						<figure>
							<img src="assets/05/mvc.png" alt="Model View Controller" title="Model View Controller" width="800" />
							<figcaption>MVC Schematic <em>(<a href="http://www.dubberly.com/articles/model-view-controller-pattern.html">ref</a>)</em></figcaption>
						</figure>
					</section>
				</section>


				<section>
					<section>
						<h2>Introducing ORM</h2>
					</section>

					<section>
						<h2>ORM</h2>
						<ul>
							<li class="fragment">
								Short for <strong>Object-Relational Mapping</strong>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Connect data in the DB with objects in an object-oriented programming environment
								<ul>
									<li class="fragment">Enables programming with a <em>virtual object database</em></li>
									<li class="fragment">Example: one entry (= row) of the table <code>customers</code> corresponds with one instance of the <code>Customer</code> class</li>
									<li class="fragment">Abstraction of SQL level results in less and clearer code</li>
									<li class="fragment">Typically implemented as a (part of a) library</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Active record pattern</h2>

						<ul>
							<li class="fragment">
								<a href="https://en.wikipedia.org/wiki/Active_record_pattern">Active record pattern</a>
								<ul>
									<li class="fragment">This means that an object instance is tied to a single row in the table</li>
									<li class="fragment">After creation of an object, a new row is added to the table upon save
									</li>
									<li class="fragment">An update of the object results in a row update</li>
									<li class="fragment">The class has a property or getter method for each column</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Plain PHP example v1 (part 1)</h2>

						<ul style="font-size: 85%">
							<li class="fragment">
								Assume a DB table <code>todo</code> with columns <code>id</code> (PK), <code>what</code> and <code>priority</code>
								<pre class="bigger fragment"><code class="language-php" style="font-size: 85%">class Todo {

    private $id = 0; // 0 means: not stored in DB
    public $what;
    public $priority;

    public function __construct($assocArray = []) {
        $this->id = array_key_exists('id', $assocArray)? $assocArray['id'] : 0;
        $this->what = array_key_exists('what', $assocArray)? $assocArray['what'] : '';
        $this->priority = array_key_exists('priority', $assocArray)? $assocArray['priority'] : 'low';
    }

    &hellip;</code></pre>
							</li>
						</ul>
					</section>

					<section>
						<h2>Plain PHP example v1 (part 2)</h2>
						<pre class="bigger fragment"><code class="language-php" style="font-size: 85%">    public function save() {
        if ($this->id === 0) {
            $stmt = Database::getDatabase()->prepare('INSERT INTO todos (what, priority) VALUES (?, ?);');
            $stmt->execute(array($this->what, $this->priority ));
            $this->id = Database::getDatabase()->lastInsertId();
        } else {
            $stmt = Database::getDatabase()->prepare('UPDATE todos SET what = ?, priority = ? WHERE id = ?;');
            $stmt->execute(array($this->what, $this->priority, $this->id ));
        }
    }

    public static function all() {
        $todoObjects = [];
        $stmt = Database::getDatabase()->query('SELECT * FROM todos;');
        while ($todo = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $todoObjects[] = new Todo($todo);
        }
        return $todoObjects;
    }
}</code></pre>

					</section>

					<section>
						<h2>Plain PHP example v1 (part 3)</h2>

						<ul style="font-size: 85%">
							<li class="fragment">
								Demo usage
								<pre class="bigger fragment"><code class="language-php" data-overlay-example="assets/05/examples/simple-mvc/01.php">$todos = Todo::all();
var_dump($todos);

echo $todos[0]->what;

$todo = new Todo();
$todo->what = 'Go lunching !!';
$todo->priority = 'high';
$todo->save();

var_dump(Todo::all());
$todo->delete();
var_dump(Todo::all());</code></pre>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								 Not too bad but ...
								<ul>
									<li class="fragment">this version cannot be used as a library yet: the full ORM code needs to be generated or written, even when a column is added</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Plain PHP example v2 (part 1)</h2>

						<pre class="bigger fragment"><code class="language-php" style="font-size: 85%">class Model { // let's make a version of Todo that does not depend on the data model ...

    private $assocArray = []; // 'id' => 0 means: not stored in DB

    public function __get($key) { // magic method for inaccessible properties '->'
        return $this->assocArray[$key];
    }

    public function __set($key, $value) { // magic method for inaccessible properties '->'
        $this->assocArray[$key] = $value;
    }

    protected static function getTablename() {
        return strtolower(get_called_class()) . 's'; // needs some linguistic optimization
    }

    public function __construct($assocArray = []) {
        if (!array_key_exists('id', $assocArray)) {
            $assocArray['id'] = 0;
        }
        $this->assocArray = $assocArray;
    }

	&hellip;</code></pre>
					</section>

					<section>
						<h2>Plain PHP example v2 (part 2)</h2>
						<pre class="bigger fragment"><code class="language-php" style="font-size: 85%">    public function save() {
        $assocWithoutId = array_diff_key($this->assocArray, array('id' => 'dummy'));
        if ($this->id === 0) {
            $stmt = Database::getDatabase()->prepare('INSERT INTO ' . self::getTablename() . ' (' .
						implode(',', array_keys($assocWithoutId)) . ') VALUES (' .
						substr(str_repeat("?,", count($assocWithoutId)), 0, -1) . ');');
            $stmt->execute(array_values($assocWithoutId));
            $this->id = Database::getDatabase()->lastInsertId();
        } else {
            $stmt = Database::getDatabase()->prepare('UPDATE ' . self::getTablename() . ' SET ' .
						implode(' = ?,', array_keys($assocWithoutId)) . ' = ? WHERE id = ?;');
            $stmt->execute(array_values($this->assocArray));
        }
    }

    public static function all() {
        $todoObjects = [];
        $stmt = Database::getDatabase()->query('SELECT * FROM ' . self::getTablename() . ';');
        while ($todo = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $subclassName = get_called_class();
            $todoObjects[] = new $subclassName($todo);
        }
        return $todoObjects;
    }
}</code></pre>

					</section>

					<section>
						<h2>Plain PHP example v2 (part 3)</h2>

						<ul style="font-size: 85%">
							<li class="fragment">
								Demo usage
								<pre class="bigger fragment"><code class="language-php" data-overlay-example="assets/05/examples/simple-mvc/02.php">class Todo extends Model {
    // override getTablename() if you need to
}

$todos = Todo::all();
var_dump($todos);

echo $todos[0]->what;

$todo = new Todo();
$todo->what = 'Go lunching !!';
$todo->priority = 'high';
$todo->save();

var_dump(Todo::all());
$todo->delete();
var_dump(Todo::all());</code></pre>
							</li>
							<li class="fragment" style="margin-top: 0.2em;">
								That's better
								<ul>
									<li class="fragment">ORM implementation details hidden in the Model class and very few work to plug your own data model</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Plain PHP example v2: epilogue</h2>

						<ul style="font-size: 85%">
							<li class="fragment">
								Of course this example is far from complete &hellip;
								<ul>
									<li class="fragment">Eliminate <code>id</code> as the required PK column name &rarr; see v3</li>
									<li class="fragment">Robustness: code safety and type checking</li>
									<li class="fragment">Support for <code>WHERE</code>, <code>GROUP BY</code>, <code>ORDER BY</code>, &hellip;</li>
									<li class="fragment">Foreign key support</li>
								</ul>
							</li>
							<li class="fragment" style="margin-top: 1em;">
								Laravel's Eloquent ORM
								<ul>
									<li class="fragment">implements all of these features</li>
									<li class="fragment">&hellip; but we'll first need to get acquainted with Query Builder</li>
								</ul>
							</li>
						</ul>
					</section>

				</section>

				<section>
					<section>
						<h2>Query Builder</h2>
					</section>
					
					<section>
						<h2>Query Builder (1)</h2>

						<ul>
							<li class="fragment">
								Fluent interface for building SQL queries (<a href="https://laravel.com/docs/5.3/queries">docs</a>)
								<ul>
									<li class="fragment">Always start with <code>DB::table()</code></li>
									<li class="fragment">and use chained methods to filter/select/aggregate data</li>
									<li class="fragment">Automatic prevention against <strong>SQL injection</strong></li>
									
									<li class="fragment" style="margin-top: 0.5em">At the end of the chain: <code>get()</code> returning a <a href="https://laravel.com/docs/5.3/collections">Collection</a> of results
										<pre class="bigger"><code class="language-php">$users = DB::table('users')-&gt;get();</code></pre>
										<ul>
											<li class="fragment">which you can still loop with <code>foreach</code></li>
											<li class="fragment">where a result is an instance of PHP's base class having its columns accessible through properties</li>
										</ul>
										<pre class="bigger"><code class="language-php">foreach ($users as $user) {
    echo $user-&gt;name;
}</code></pre>
									</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Query Builder (2)</h2>

						<ul>
							<li class="fragment">
								Fluent interface for building SQL queries (<a href="https://laravel.com/docs/5.3/queries">docs</a>)
								<ul>
									<li class="fragment">example with <code>select()</code>, <code>where()</code> and <code>groupBy()</code>
										<pre class="bigger"><code class="language-php">$users = DB::table('users')
                     -&gt;select('name', 'email as user_email')
                     -&gt;where('status', '&lt;&gt;', 1)
                     -&gt;groupBy('status')
                     -&gt;get();</code></pre>
										<code>get()</code> is the only method actually performing a query here !
									</li>											
								</ul>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Query Builder (3)</h2>

						<ul>
							<li class="fragment">
								Fluent interface for building SQL queries (<a href="https://laravel.com/docs/5.3/queries">docs</a>)
								<ul>
									<li class="fragment"><code>first()</code> returns a single row
										<pre class="bigger"><code class="language-php">$user = DB::table('users')-&gt;where('name', 'John')-&gt;first();
echo $user-&gt;name;</code></pre>
									</li>
									<li class="fragment"><code>value()</code> returns a single value
										<pre class="bigger"><code class="language-php">$email = DB::table('users')-&gt;where('name', 'John')-&gt;value('email');</code></pre>
									</li>
									<li class="fragment"><code>pluck()</code> returns a <strong>Collection</strong> of custom keys and <strong>values</strong>
										<pre class="bigger"><code class="language-php">$events = DB::table('event')-&gt;pluck('name', 'id');
										
foreach ($events as $id =&gt; $name) { 
	&hellip;</code></pre>
									</li>

								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Query Builder (4)</h2>

						<ul>
							<li class="fragment">
								Fluent interface for building SQL queries (<a href="https://laravel.com/docs/5.3/queries">docs</a>)
								<ul>
									<li class="fragment">aggregate methods e.g. <code>count()</code>, <code>max()</code></li>
									<li class="fragment">much more e.g. <code>whereIn()</code>, <code>orWhere()</code>, joins e.g. <code>leftJoin()</code>, <code>on()</code> </li>		
									<li class="fragment">Examples with <code>insert()</code>, <code>update()</code> and <code>delete()</code>
										<pre class="bigger"><code class="language-php">$id = DB::table('users')->insertGetId(
    ['email' => 'john@example.com', 'votes' => 0]
);

DB::table('users')
            ->where('id', 1)
            ->update(['votes' => 1]);
			
DB::table('users')->increment('votes', 5);
		
DB::table('users')->where('votes', '&lt;', 100)->delete();
</code></pre>
									</li>
								</ul>
							</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>Eloquent ORM</h2>
					</section>

					<section>
						<h2>Defining the models (1)</h2>

						<ul>
							<li class="fragment">
								ORM: each database table has a corresponding "Model" which is used to interact with it (<a
									href="https://laravel.com/docs/5.3/eloquent">Eloquent docs</a>)
							</li>
							<li class="fragment">
								First step: generate the models with Artisan (! uppercase)
								<pre class="bigger"><code class="language-bash dontrun" style="max-height: 380px; overflow: scroll;">$ php artisan make:model <u>E</u>vent</code></pre>
								<ul>
									<li class="fragment">It generates the (pretty empty) class <code>Event</code> extending <code>Illuminate\Database\Eloquent\Model</code> in the <code>app/</code> directory</li>
									<li class="fragment">The model assumes that there is a table <code>events</code> (plural!) in the database, unless you add
<pre class="bigger"><code class="language-php">protected $table = 'my_other_table_name';</code></pre>
									</li>						
								</ul>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Defining the models (2)</h2>

						<ul>
							<li class="fragment">
								First step: generate the models with Artisan
								<ul>
									<li class="fragment">The model assumes the table has an (auto-increment) primary key called <code>id</code>, unless you add
<pre class="bigger"><code class="language-php">protected $primaryKey = 'event_id';
protected $incrementing = false;</code></pre>
									</li>
									<li class="fragment">The model assumes that the table has <code>created_at</code> and <code>updated_at</code> columns, unless you add
<pre class="bigger"><code class="language-php">public $timestamps = false;</code></pre>
										<ul>
											<li class="fragment">Eloquent will automatically update these columns when creating/changing data</li>
											<li class="fragment">Raw SQL Queries won't</li>						
										</ul>
									</li>								
								</ul>
							</li>
						</ul>
						<footer class="fragment"><em>Note: there are also settings on timestamp column names and formats</em></footer>
					</section>		

					<section>
						<h2>Retrieving data</h2>

						<ul>
							<li class="fragment">
								From now on, you can filter/select/aggregate data using the model
								<ul>
									<li class="fragment">Eloquent's <code>all()</code> returns all records in the table
<pre class="bigger"><code class="language-php">use App\Event;

$events = Event::all();</code></pre>
									</li>
									<li class="fragment">Rely on Query Builder for many other (chained) methods
<pre class="bigger"><code class="language-php">use App\Event;

$events = Event::where('active', 1)
               -&gt;orderBy('name', 'desc')
               -&gt;get();</code></pre>
									</li>								
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Find or fail</h2>

						<ul>
							<li class="fragment">
								Retrieving single records with Eloquent's <code>find()</code> and <code>first()</code>
								<pre class="bigger"><code class="language-php">use App\Event;

$event15 = Event::find(15); // retrieval by primary key
$activeEvent = Event::where('active', 1)->first(); // retrieve the first record</code></pre>
								<ul>
									<li class="fragment">Throw a <code>ModelNotFoundException</code> when no result is found:
										<pre class="bigger"><code class="language-php">$event15 = Event::findOrFail(15);
$activeEvent = Event::where('active', 1)->firstOrFail();</code></pre>
									</li>
									<li class="fragment">Results in a <code>404</code> HTTP response when not caught (!)</li>
								</ul>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Active record</h2>

						<ul>
							<li class="fragment">
								You can insert, update and delete rows correspondingly to the <a href="https://en.wikipedia.org/wiki/Active_record_pattern">active record pattern</a>
								<pre class="bigger"><code class="language-php">use App\Event;

$event = new Event;
$event-&gt;name = $request->name;
$event-&gt;save();

$event = Event::find(1);
$event-&gt;name = 'Pukkelpop 2016';
$event-&gt;save();

$event-&gt;delete();
</code></pre>
								<ul>
									<li class="fragment">But note that the Query Builder examples with <code>insert()</code>, <code>update()</code> and <code>delete()</code> will work too. Eloquent also enables deletion by PK: <code class="language-php">Event::destroy(7);</code>
									</li>							
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Mass-assignment vulnerability (1)</h2>

						<ul>
							<li class="fragment">
								Mass assignment
								<ul>
									<li class="fragment">Definition: use the create method to save a new model in a single line
									<pre class="bigger"><code class="language-php">$user = App\User::create(['name' =&gt; 'Franky Pallemans', 'company' =&gt; 'Cynalco']);</code></pre>
									</li>
									<li class="fragment">It enables to pass all parameter/value-pairs of the HTTP request's querystring to the create method
									<pre class="bigger"><code class="language-php">$user = App\User::create($request-&gt;all());</code></pre>
									</li>
									<li class="fragment"><strong>Mass-assignment vulnerability</strong>: a malicious user adds a parameter to the HTTP request e.g. <code>role=administrator</code> which is passed to the create method
									</li>						
								</ul>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Mass-assignment vulnerability (2)</h2>

						<ul>
							<li class="fragment">
								Mass assignment vulnerability protection
								<ul>
									<li class="fragment">It is required to
										<ul>
											<li class="fragment">blacklist: <code>protected $guarded = ['role'];</code>
											</li>
											<li class="fragment">or whitelist: <code>protected $fillable = ['name', 'company'];</code>
											</li>												
										</ul>
									  the mass assignable attributes in the model class
									</li>
									
									<li class="fragment">Attention: when you pass a blacklisted/not-whitelisted parameter to the create method
										<ul>
											<li class="fragment">You don't get an error
											</li>
											<li class="fragment">Laravel just drops that parameter</code>
											</li>												
										</ul>
									</li>
									<li class="fragment">It only applies to vulnerable methods so you can still
									<pre class="bigger"><code class="language-php">$user-&gt;role = 'administrator';
$event-&gt;save();</code></pre>
									</li>
								
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>More mass-assignment methods</h2>

						<ul>
							<li class="fragment">
								Apply <code>fill()</code> on a model instance
								<pre class="bigger"><code class="language-php">use App\Event;

$event = new Event;
$event-&gt;fill(['name' => 'Pukkelpop 2017']);</code></pre>
							</li>
							<li class="fragment">
								Conditional creation
								<pre class="bigger"><code class="language-php">// Retrieve the event by the attributes, or create it if it doesn't exist...
$event = Event::firstOrCreate(['name' => 'Dranouter 2017']);

// Retrieve the event by the attributes, or instantiate a new instance...
$event = Event::firstOrNew(['name' => 'Dranouter 2017']);
$event-&gt;save();

// If there's a matching event, set the price to $99.
// If no matching event exists, create one.
$event = Event::updateOrCreate(['name' => 'Dranouter 2017'], ['price' => 99]);</code></pre>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Eloquent relationships (1)</h2>

						<ul>
							<li class="fragment">
								One-to-many example
								<ul>
									<li class="fragment">Suppose a 1:n relation between <em>users</em> and <em>tasks</em> &rarr; table <em>tasks</em> has a foreign key
									</li>
									<li class="fragment">Instead of working with FKs in Laravel, you want to interact with the related objects directly
										<pre class="bigger"><code class="language-php">$user = App\User::find(1);

foreach ($user-&gt;tasks as $task) {
    echo $task-&gt;name;
}
</code></pre>
									</li>						
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Eloquent relationships (2)</h2>

						<ul>
							<li class="fragment">
								Bidirection support 1:n
								<ul>
									</li>
									<li class="fragment">Add to the <code>User</code> class: (! plural)
										<pre class="bigger"><code class="language-php">public function tasks()
{
        return $this-&gt;hasMany('App\Task');
}
</code></pre>
									</li>
									
<li class="fragment">Add to the <code>Task</code> class: (! singular)
										<pre class="bigger"><code class="language-php">public function user()
{
        return $this-&gt;belongsTo('App\User');
}
</code></pre>
									</li>

									<li class="fragment">Read the <a href="https://laravel.com/docs/5.3/eloquent-relationships">docs on Eloquent relationships</a> to learn about other types of relationships
									</li>							
								</ul>
							</li>
						</ul>
						<footer class="fragment"><em><code>hasMany</code> and <code>belongsTo</code> have further options for non-default column names</em></footer>
					</section>

					<section>
						<h2>Eloquent with dates and times</h2>

						<ul>
							<li class="fragment">
								As you know, Laravel comes with <a href="http://carbon.nesbot.com/docs/">Carbon</a><pre class="bigger"><code class="language-php">use Carbon\Carbon;</code></pre>
								<ul>
									<li class="fragment">The Carbon class extends the PHP <a href="http://www.php.net/manual/en/class.datetime.php">DateTime</a> class
									</li>
									<li class="fragment">You can use it as part of a query
										<pre class="bigger"><code class="language-php">$events = Event::where('event_date', '<', new Carbon('yesterday 23:10'))-&gt;get();
</code></pre>
									</li>
									<li class="fragment">In order to have a Carbon object auto-casted at any time in Eloquent, you need to tell Eloquent first
										<pre class="bigger"><code class="language-php">class Event extends Model
{
	// keep the default date fields created_at and updated_at !
    protected $dates = ['created_at', 'updated_at', 'event_date']; 
}
</code></pre>
									</li>
									<li class="fragment">Now you can do things like <code>$event-&gt;event_date = Carbon::now();</code></li>
								</ul>
							</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>Intermezzo: Migrations</h2>
					</section>

					<section>
						<h2>Migrations (1)</h2>

						<ul>
							<li class="fragment">
								Typical dev team situation
								<ul>
									<li class="fragment">All team members have a local (test) instance of the database </li>
									<li class="fragment">From time to time the DB schema is modified</li>
									<li class="fragment">How can we easily share these changes?
									<ul>
									<li class="fragment">By changing the global SQL-dump and put it to version control? Maybe, but it doesn't scale </li>		
									<li class="fragment">By adding an SQL-update file and put it to version control? Maybe, but it is difficult to produce and it is not structured</li>
									</ul></li>
								</ul>
							</li>
							<li class="fragment">
								Solution: Database Migrations
								<ul>
									<li class="fragment">Easily modify and share the application's database schema. </li>
									<li class="fragment">It's like version control for your DB</li>
									
								</ul>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Migrations (2)</h2>

						<ul>
							<li class="fragment">
								How does it work?
								<ul>
									<li class="fragment">A modification to the DB schema is described in a migration class file, named with a timestamp, located in <code>database/migrations</code> </li>
									<li class="fragment">A migration class contains two methods: <code>up</code> (perform migration) and <code>down</code> (reverse).</li>
									<li class="fragment">These modification are programmed with Laravel schema builder </li>
									<li class="fragment" style="margin-top: 1em">Artisan helps you to create blueprints of migration classes </li>
									<li class="fragment">Put successful migrations to version control </li>
									<li class="fragment">In one Artisan command, you can execute all migrations that have not been executed before (logged in the DB table <code>migrations</code>)</li>
								</ul>
							</li>

							<li class="fragment">
								Read more about it in the <a href="https://laravel.com/docs/5.3/migrations">Laravel docs on Migrations</a>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Migrations (3)</h2>

						<ul>
							<li class="fragment">
								Example: table creation
								<pre class="bigger"><code class="language-bash dontrun">$ php artisan make:migration create_events_table --create=events</code></pre>
								<ul>
									<li class="fragment">generates <code>database/migrations/&lt;timestamp&gt;_create_events_table.php</code>
<pre class="bigger"><code class="language-php">class CreateEventsTable extends Migration
{
    public function up()
    {
        Schema::create('events', function (Blueprint $table) {
            $table-&gt;increments('id'); // your table has a PK auto-inc id column
            $table-&gt;timestamps(); // your table has created_at and updated_at columns
        });
    }

    public function down()
    {
        Schema::drop('events');
    }
}</code></pre>
									</li>						
								</ul>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Migrations (4)</h2>

						<ul>
							<li class="fragment">
								Example: table creation
								<ul>
									<li class="fragment">complete the schema creation
<pre class="bigger"><code class="language-php">public function up()
{
	Schema::create('events', function (Blueprint $table) {
		$table-&gt;increments('id'); // LEAVE IT HERE
		$table-&gt;string('title');
		$table-&gt;text('description');
		$table-&gt;date('event_date');
		
		// foreign key: column types need to be EXACTLY the same
		$table-&gt;integer('location_id')-&gt;unsigned(); // 
		$table-&gt;foreign('location_id')-&gt;references('location_id')-&gt;on('locations');
		
		$table-&gt;timestamps(); // LEAVE IT HERE
	});
}</code></pre>
									</li>
									<li class="fragment">run all migrations
<pre class="bigger"><code class="language-bash">$ php artisan migrate</code></pre>
									</li>											
								</ul>
							</li>
						</ul>
					</section>					
					
					<!--section>
						<h2>Migrations bug with MySQL utf8mb4</h2>

						<ul>
							<li class="fragment" style="font-size: 80%">
								The <a href="http://aoverton.com/web-development/using-mysql-utf8mb4-with-laravel-5/">problem</a>
								<ul>
									<li class="fragment">Definition of string columns with Migrations<pre class="bigger"><code class="language-php">$table-&gt;string('name');
$table-&gt;string('email')-&gt;unique();
</code></pre></li>
									<li class="fragment">Default string length in Laravel's Schema Builder: 255 chars</li>
									<li class="fragment">With utf8mb4: 255 * 4 = 1020 bytes</li>
									<li class="fragment">Max length: 1000 bytes for MyISAM, 767 bytes for InnoDB<pre><code class="language-bash">[Illuminate\Database\QueryException] SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key 
was too long; max key length is 767 bytes (SQL: alter table `users` add unique users_email_unique(`email`))
</code></pre></li>
									
								</ul>
							</li>
							<li class="fragment" style="font-size: 80%">
								Solutions
								<ul>
									<li class="fragment">Best: correct string lengths<pre class="bigger"><code class="language-php">$table-&gt;string('name', 191);
$table-&gt;string('email', 191)-&gt;unique();
</code></pre></li>
									<li class="fragment">Good: just use <em>utf8</em> (= 3-byte-encoding) for your DB</li>
									<li class="fragment">
										Bad: replace <em>utf8mb4</em> by <em>utf8</em> in <code>config/database.php</code> 
										&rarr; you're fooling the system
									</li>
								</ul>
							</li>

						</ul>
					</section-->
					
					<section>
						<h2>Developing with Eloquent and Migrations</h2>

						<ul>
							<li class="fragment">
								Typical flow
								<pre class="bigger"><code class="language-bash dontrun" style="max-height: 380px; overflow: scroll;"># start from an empty DB

# creates both a model and a create_products_table migration:
$ php artisan make:model Product -m

# migration contains: $table-&gt;increments('id');
# migration contains: $table-&gt;timestamps();
# add to your migration: other columns

$ php artisan migrate

# add to your model: mass-assignable blacklist/whitelist and dates/times

# use App\Product wherever you want for your DB operations</code></pre>
							</li>

						</ul>
						<footer class="fragment"><em>Note: Laravel comes with a pre-installed (extensible) migration and model for a <code>users</code> table </em></footer>
					</section>		

				</section>
				
				
				<section>
					<section>
						<h2>MVC recap</h2>
					</section>
					
					<section>
						<h2>MVC in Laravel: overview</h2>
						<p><img src="assets/05/mvc_diagram_with_routes.png" alt="" title="" width="600" style="background-color:white;" />
						<div style="font-size: 50%; line-height: 100%;margin-top: -1em;">
							Source: <a href="https://selftaughtcoders.com/from-idea-to-launch/lesson-17/laravel-5-mvc-application-in-10-minutes/">selftaughtcoders.com</a></span>
						</div>
					</section>

					<section>
						<h2>MVC in Laravel: overview</h2>
						<ul>
							<li class="fragment"><strong>Models</strong>: generate Eloquent models with Artisan</li>
							<li class="fragment" style="margin-top: 1em;"><strong>Views</strong>: store your Blade (or PHP) templates in <code>resources/views</code> </li>
							<li class="fragment" style="margin-top: 1em;"><strong>Controllers</strong>: see next slide(s)</li>							
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>HTTP Controllers</h2>
					</section>

					<section>
						<h2>HTTP Controllers (1)</h2>

						<ul style="font-size: 80%">
							<li class="fragment">Create a <code>*Controller</code> in the folder <code>app/Http/Controllers</code>
								<pre class="bigger fragment"><code class="language-bash dontrun">php artisan make:controller TaskController</code></pre>
							</li>
							<li class="fragment">
								Point to its <strong>methods</strong> in <code>/routes/web.php</code>
								<pre class="bigger fragment"><code class="language-php">Route::get('/tasks', 'TaskController@index');
Route::post('/task', 'TaskController@store');
Route::delete('/task/{task}', 'TaskController@destroy');</code></pre>
							</li>
							<li class="fragment">
								Write the appropriate method(s) in <code>*Controller</code>
								<pre class="bigger fragment"><code class="language-php">class TaskController extends Controller
{
	public function index(Request $request)
    {
		$tasks = Task::where('user_id', $request-&gt;input('user_id'))
                    -&gt;orderBy('created_at', 'asc')
                    -&gt;get();
        return view('tasks.index', ['tasks' =&gt; $tasks]);
    }
	
	public function destroy(Request $request, $id) </code></pre>
							</li>
						</ul>
					</section>  
					
					<section>
						<h2>HTTP Controllers (2)</h2>

						<ul style="font-size: 80%">
							<li class="fragment">
								Only include the (type-hinted) $request parameter when needed
								<pre class="bigger fragment"><code class="language-php">class TaskController extends Controller
{
	public function index()
    {
        return view('tasks.index');
    }</code></pre>
							</li>
							<li class="fragment">
								<a href="https://laravel.com/docs/5.3/routing#route-model-binding">Implicit model binding:</a> Eloquent will use the <code>id</code> column
								<pre class="bigger fragment"><code class="language-php">Route::delete('/task/{task}', 'TaskController@destroy');</code></pre>
								<pre class="bigger fragment"><code class="language-php">class TaskController extends Controller
{
	&hellip;
	public function destroy(Task $task) // implicit model binding (on ID) + 404 on fail
	{
		$task-&gt;delete();
		return redirect('/tasks');
    }</code></pre>
							</li>
						</ul>
						<footer class="fragment" style="line-height: 100%;"><em>Override the model's <code>getRouteKeyName()</code> in order to use another column for this</em></footer>
						
					</section> 

					<section>
						<h2>Repositories (1)</h2>

						<ul>
							<li class="fragment">Repositories in Laravel
								<ul>
									<li class="fragment" style="margin-top: 1em;">Only useful for complex queries you'd call from multiple locations in your code (cf. code reuse)</li>
								</ul>
							</li>
						</ul>
					</section>					
					
					<section>
						<h2>Repositories (2)</h2>

						<ul>
							<li class="fragment">Create the <code>app/Repositories</code> directory and add a <code>*Repository</code> class yourself
								<pre class="bigger fragment"><code class="language-php dontrun">&lt;?php
namespace App\Repositories; // there is PSR-4 autoloading ...

use App\Task;

class TaskRepository
{
    public function forUserId($id)
    {
        return Task::where('user_id', $id)
                    -&gt;orderBy('created_at', 'asc')
                    -&gt;get();
    }
	&hellip;
}</code></pre>
							</li>
						</ul>
					</section>
					
					<section>
						<h2>Repositories (3)</h2>

						<ul>
							<li class="fragment">
								Inject the repository in the corresponding <code>*Controller</code>
								<pre class="bigger fragment"><code class="language-php">namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Repositories\TaskRepository;

class TaskController extends Controller
{
    protected $tasks;

    public function __construct(TaskRepository $tasks)
    {
        $this-&gt;tasks = $tasks;
    }

    public function index(Request $request)
    {
        return view('tasks.index', [
            'tasks' =&gt; $this-&gt;tasks-&gt;forUserId($request-&gt;input('user_id'))
        ]);
    }
	&hellip;
}</code></pre>
							</li>
						</ul>
					</section>

				
					
				</section>				
				
				<!-- The END -->
				<section>
					<section>
						<h2>Questions?</h2>
						<footer>
							<em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:joris.maervoet@odisee.be">joris.maervoet@odisee.be</a></em>
						</footer>
					</section>
				</section>



				<!-- Sources -->
				<section id="sources">
					<section>
						<h2>Sources</h2>
						
						
						<ul>
							<li><a href="https://laravel.com/docs/5.3/queries">Laravel docs: Database: Query Builder</a></li>
							<li><a href="https://laravel.com/docs/5.3/eloquent">Laravel docs: Eloquent: Getting Started</a></li>
							<li><a href="https://laravel.com/docs/5.3/migrations">Laravel docs: Migrations</a></li>
							<li><a href="https://laravel.com/docs/5.2/quickstart">Laravel tutorial on a task list project - basic</a> version 5.2!</li>
							<li><a href="https://laravel.com/docs/5.2/quickstart-intermediate">Laravel tutorial on a task list project - intermediate</a> version 5.2!</li>
							
							<li><a href="https://laravel.com/docs/5.3/controllers">Laravel docs: Controllers</a></li>
							<li><a href="https://laravel.com/docs/5.3/routing#route-model-binding">Laravel docs: Route Model Binding</a></li>

						</ul>
					</section>
				</section>

			</div>

			<!-- The navigational controls UI -->
			<aside class="controls">
				<a class="left" href="#">&#x25C4;</a>
				<a class="right" href="#">&#x25BA;</a>
				<a class="up" href="#">&#x25B2;</a>
				<a class="down" href="#">&#x25BC;</a>
				<span id="revealIndex">/</span>
			</aside>

			<!-- Index Link -->
			<aside class="back">
				<a href="index.html">&larr; Back to index</a>
			</aside>

			<!-- ikdoeict.be Link -->
			<a href="http://www.ikdoeict.be/" title="ikdoeict.be" id="ikdoeict">ikdoeict.be</a>

			<!-- Displays presentation progress, max value changes via JS to reflect # of slides -->
			<div class="progress"><span></span></div>

		</div>

		<script src="js/reveal.js"></script>
		<script src="lib/highlight.js"></script>
		<script src="lib/prefixfree.js"></script>
		<script src="lib/css-snippets.js"></script>
		<script src="lib/css-edit.js"></script>
		<script src="lib/incrementable.js"></script>
		<script src="js/main.js"></script>

	</body>
</html>